<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>æ–‡ä»¶å¤¹æµè§ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: sans-serif;
    max-width: 640px;
    margin: 0 auto;
    padding: 20px;
    background: #f5f7fa;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
  }
  ul {
    list-style: none;
    padding: 0;
  }
  li {
    padding: 6px 0;
    font-size: 14px;
    border-bottom: 1px dashed #eee;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  li a {
    color: #3498db;
    text-decoration: none;
    flex: 1;
  }
  li a:hover {
    text-decoration: underline;
  }
  button.delete-btn {
    background-color: #e74c3c;
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    margin-left: 10px;
  }
  button.delete-btn:hover {
    background-color: #c0392b;
  }
  .upload-btn {
    width: 100%;
    padding: 14px;
    margin: 10px 0;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
  }
  .upload-btn.back-btn {
    background-color: #aaa;
  }
  /* ä¸Šä¼ è¿›åº¦æ¡ */
  .progress-container {
    width: 100%;
    height: 8px;
    background-color: #eee;
    border-radius: 4px;
    margin: 10px 0;
    display: none;
  }
  .progress-bar {
    height: 100%;
    background-color: #3498db;
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
  }
  .progress-text {
    color: #666;
    font-size: 14px;
    text-align: center;
    margin-bottom: 10px;
    display: none;
  }
</style>
</head>
<body>

<h2 id="folderTitle">åŠ è½½ä¸­...</h2>

<!-- ä¸Šä¼ è¿›åº¦æ¡ -->
<div class="progress-text" id="uploadProgressText">æ­£åœ¨ä¸Šä¼ ...</div>
<div class="progress-container" id="uploadProgressContainer">
  <div class="progress-bar" id="uploadProgressBar"></div>
</div>

<input type="file" id="fileInput" multiple style="display:none" />
<button class="upload-btn" onclick="document.getElementById('fileInput').click()">ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</button>
<button class="upload-btn back-btn" onclick="goBack()">è¿”å›å…¶ä»–ç›®å½•</button>

<ul id="fileList"></ul>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const folderName = urlParams.get('folder') || '';
  const folderTitle = document.getElementById('folderTitle');
  const fileList = document.getElementById('fileList');

  folderTitle.textContent = `æ–‡ä»¶å¤¹: ${folderName}`;

  // åŠ è½½æ–‡ä»¶åˆ—è¡¨
  function loadFolderFiles() {
    fetch(`/files/${encodeURIComponent(folderName)}`)
      .then(res => {
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        return res.json();
      })
      .then(data => {
        fileList.innerHTML = '';
        if (!data || data.length === 0) {
          fileList.innerHTML = '<li>è¯¥æ–‡ä»¶å¤¹ä¸ºç©º</li>';
          return;
        }
        data.forEach(item => {
          const li = document.createElement('li');
          if (item.is_dir) {
            // æ–‡ä»¶å¤¹ä¸å…è®¸åµŒå¥—æµè§ˆï¼Œæ˜¾ç¤ºåç§° + åˆ é™¤æŒ‰é’®
            li.textContent = `ğŸ“ ${item.name} ï¼ˆç¦æ­¢åµŒå¥—ï¼‰`;
            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const btn = createDeleteButton(item.name, true);
            li.appendChild(btn);
          } else {
            // æ–‡ä»¶ï¼Œæ˜¾ç¤ºé“¾æ¥å’Œåˆ é™¤æŒ‰é’®
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(folderName)}/${encodeURIComponent(item.name)}`;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.title = item.name;
            a.textContent = item.name.length > 30 ? item.name.slice(0, 27) + '...' : item.name;
            li.appendChild(a);
            if (item.size) {
              const sizeSpan = document.createElement('span');
              sizeSpan.textContent = ` (${item.size})`;
              sizeSpan.style.marginLeft = '6px';
              li.appendChild(sizeSpan);
            }
            const btn = createDeleteButton(item.name, false);
            li.appendChild(btn);
          }
          fileList.appendChild(li);
        });
      })
      .catch(() => {
        fileList.innerHTML = '<li>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</li>';
      });
  }

  // åˆ›å»ºåˆ é™¤æŒ‰é’®
  function createDeleteButton(name, isDir) {
    const btn = document.createElement('button');
    btn.textContent = 'åˆ é™¤';
    btn.className = 'delete-btn';
    btn.onclick = () => {
      if (confirm(`ç¡®å®šè¦åˆ é™¤${isDir ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'} "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        deleteItems([name], isDir);
      }
    };
    return btn;
  }

  // è°ƒç”¨åç«¯æ‰¹é‡åˆ é™¤æ¥å£
  function deleteItems(names, isDir) {
    // æ„é€ pathsï¼Œæ–‡ä»¶å¤¹ä¸å…è®¸åµŒå¥—ï¼Œè¿™é‡Œè·¯å¾„ä¸º folderName + / + name
    const paths = names.map(n => `${folderName}/${n}`);
    fetch('/batch_delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ paths })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert('åˆ é™¤å¤±è´¥: ' + data.error);
      } else {
        alert('åˆ é™¤ä»»åŠ¡å·²æäº¤ï¼Œç¨ååˆ·æ–°æ–‡ä»¶åˆ—è¡¨');
        // ç­‰ä¸€å°æ®µæ—¶é—´ååˆ·æ–°åˆ—è¡¨
        setTimeout(loadFolderFiles, 1500);
      }
    })
    .catch(() => alert('åˆ é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•'));
  }

  document.getElementById('fileInput').addEventListener('change', function() {
    const files = this.files;
    if (!files.length) return;

    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');

    progressContainer.style.display = 'block';
    progressText.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';

    const formData = new FormData();
    for (let file of files) {
      formData.append('file', file);
    }
    formData.append('folder', folderName);
    formData.append('user', '');

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload');

    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percent + '%';
        progressText.textContent = `æ­£åœ¨ä¸Šä¼ : ${percent}%`;
      }
    });

    xhr.addEventListener('load', function() {
      if (xhr.status === 200) {
        progressText.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
        loadFolderFiles();
        setTimeout(() => {
          progressContainer.style.display = 'none';
          progressText.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
      } else {
        progressText.textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    });

    xhr.send(formData);
  });

  function goBack() {
    window.location.href = '/'; // è¿”å›é¦–é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆ†ç±»
  }

  // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ–‡ä»¶
  loadFolderFiles();
</script>

</body>
</html>