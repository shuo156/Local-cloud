<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>多级目录选择上传</title>
<style>
  body {
    max-width: 640px;
    margin: 0 auto;
    font-family: sans-serif;
    padding: 10px;
  }
  ul.folder-tree {
    list-style: none;
    padding-left: 20px;
  }
  ul.folder-tree li {
    cursor: pointer;
    margin: 4px 0;
  }
  ul.folder-tree li span.folder-name {
    user-select: none;
  }
  ul.folder-tree li span.folder-name.selected {
    color: #3498db;
    font-weight: bold;
  }
  button.upload-btn {
    margin-top: 12px;
    padding: 10px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
  }
</style>
</head>
<body>

<h2>选择上传目标文件夹</h2>
<div id="folderContainer"></div>

<input type="file" id="fileInput" multiple />
<button class="upload-btn" onclick="uploadFiles()">上传文件</button>

<script>
const BASE_FOLDER = ''; // 如果你想限定起始目录，可写如 '其他'，否则空字符串
let selectedPath = '';  // 记录当前选中路径

// 递归获取文件夹下的子文件夹
async function fetchSubfolders(path) {
  const url = path ? `/files/${encodeURIComponent(path)}` : '/files';
  const res = await fetch(url);
  if (!res.ok) return [];
  const data = await res.json();
  // 过滤出文件夹
  return data.filter(item => item.is_dir).map(item => item.name);
}

// 递归渲染文件夹树
async function renderFolderTree(container, path) {
  const ul = document.createElement('ul');
  ul.className = 'folder-tree';
  const folders = await fetchSubfolders(path);
  for (const folder of folders) {
    const li = document.createElement('li');
    const span = document.createElement('span');
    span.textContent = folder;
    span.className = 'folder-name';
    span.onclick = () => {
      // 取消所有其他选中
      container.querySelectorAll('.folder-name.selected').forEach(el => el.classList.remove('selected'));
      span.classList.add('selected');
      selectedPath = path ? `${path}/${folder}` : folder;
    };
    li.appendChild(span);

    // 添加可展开按钮
    const toggleBtn = document.createElement('button');
    toggleBtn.textContent = '+';
    toggleBtn.style.marginLeft = '8px';
    toggleBtn.onclick = async (e) => {
      e.stopPropagation();
      if (li.querySelector('ul')) {
        // 已展开，移除
        li.removeChild(li.querySelector('ul'));
        toggleBtn.textContent = '+';
      } else {
        // 展开子目录
        toggleBtn.textContent = '–';
        await renderFolderTree(li, selectedPath ? selectedPath : (path ? `${path}/${folder}` : folder));
      }
    };
    li.insertBefore(toggleBtn, span);

    ul.appendChild(li);
  }
  container.appendChild(ul);
}

async function loadTree() {
  const container = document.getElementById('folderContainer');
  container.innerHTML = '';
  selectedPath = BASE_FOLDER || '';
  await renderFolderTree(container, BASE_FOLDER);
}

async function uploadFiles() {
  const files = document.getElementById('fileInput').files;
  if (files.length === 0) {
    alert('请选择文件');
    return;
  }
  if (!selectedPath) {
    alert('请先选择上传目标文件夹');
    return;
  }
  const formData = new FormData();
  for (const f of files) {
    formData.append('file', f);
  }
  formData.append('folder', selectedPath);
  const res = await fetch('/upload', { method: 'POST', body: formData });
  const result = await res.json();
  alert(result.message || result.error);
  if (!result.error) {
    document.getElementById('fileInput').value = ''; // 清空文件选择
  }
}

window.onload = loadTree;
</script>
</body>
</html>