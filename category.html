<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>åˆ†ç±»æ–‡ä»¶æµè§ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: sans-serif;
    max-width: 640px;
    margin: 0 auto;
    padding: 20px;
    background: #f5f7fa;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
  }
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  li {
    padding: 8px 0;
    font-size: 14px;
    border-bottom: 1px dashed #eee;
    word-break: break-all;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  a {
    color: #3498db;
    text-decoration: none;
    flex: 1;
  }
  a:hover {
    text-decoration: underline;
  }
  .filename {
    max-width: 70vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
  }
  .back-link {
    display: block;
    margin-bottom: 20px;
    font-size: 14px;
    color: #555;
  }
  button.delete-btn {
    background-color: #e74c3c;
    border: none;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    margin-left: 10px;
  }
  button.delete-btn:hover {
    background-color: #c0392b;
  }
</style>
</head>
<body>

<a href="/home.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
<h2 id="categoryTitle">åŠ è½½ä¸­...</h2>
<ul id="fileList"></ul>

<script>
  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  const category = getQueryParam('name');

  function loadCategoryFiles(category) {
    if (!category) {
      document.getElementById('categoryTitle').textContent = 'åˆ†ç±»åç¼ºå¤±';
      return;
    }
    document.getElementById('categoryTitle').textContent = `åˆ†ç±»: ${category}`;

    fetch(`/files/${encodeURIComponent(category)}`)
      .then(res => {
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        return res.json();
      })
      .then(files => {
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        if (!files || files.length === 0) {
          list.innerHTML = '<li>æš‚æ— æ–‡ä»¶</li>';
          return;
        }
        files.forEach(f => {
          const fileName = f.name || f.path || '';
          const safeName = encodeURIComponent(fileName);
          const li = document.createElement('li');

          if (f.is_dir) {
            // æ–‡ä»¶å¤¹ï¼Œè·³è½¬åˆ° folder.html?folder=...
            const a = document.createElement('a');
            a.href = `/folder.html?folder=${safeName}`;
            a.textContent = 'ğŸ“ ' + fileName;
            a.title = fileName;
            a.className = 'filename';
            li.appendChild(a);

            // åˆ é™¤æŒ‰é’®
            const btn = createDeleteButton(fileName, true);
            li.appendChild(btn);
          } else {
            // æ–‡ä»¶ï¼Œæä¾›ä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(category)}/${safeName}`;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.title = fileName;
            a.className = 'filename';
            a.textContent = fileName;
            li.appendChild(a);

            if (f.size) {
              const sizeSpan = document.createElement('span');
              sizeSpan.textContent = ` (${f.size})`;
              sizeSpan.style.marginLeft = '6px';
              li.appendChild(sizeSpan);
            }
            // åˆ é™¤æŒ‰é’®
            const btn = createDeleteButton(fileName, false);
            li.appendChild(btn);
          }
          list.appendChild(li);
        });
      })
      .catch(err => {
        document.getElementById('categoryTitle').textContent = 'åŠ è½½å¤±è´¥';
        console.error(err);
      });
  }

  function createDeleteButton(name, isDir) {
    const btn = document.createElement('button');
    btn.textContent = 'åˆ é™¤';
    btn.className = 'delete-btn';
    btn.onclick = () => {
      if (confirm(`ç¡®å®šè¦åˆ é™¤${isDir ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'} "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        deleteItems([name], isDir);
      }
    };
    return btn;
  }

  function deleteItems(names, isDir) {
    // æ„é€ è·¯å¾„æ ¼å¼ä¸º  åˆ†ç±»å/æ–‡ä»¶å æˆ– åˆ†ç±»å/æ–‡ä»¶å¤¹å
    const paths = names.map(n => `${category}/${n}`);
    fetch('/batch_delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ paths })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert('åˆ é™¤å¤±è´¥: ' + data.error);
      } else {
        alert('åˆ é™¤ä»»åŠ¡å·²æäº¤ï¼Œç¨ååˆ·æ–°æ–‡ä»¶åˆ—è¡¨');
        setTimeout(() => loadCategoryFiles(category), 1500);
      }
    })
    .catch(() => alert('åˆ é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•'));
  }

  loadCategoryFiles(category);
</script>

</body>
</html>